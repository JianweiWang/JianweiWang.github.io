<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Service And Kube-proxy | Terminus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Introduction本文探究kubernetes架构中，服务发现的具体工作原理，涉及到service定义、服务发现与coredns，kube-proxy工作原理等。">
<meta name="keywords" content="service">
<meta property="og:type" content="article">
<meta property="og:title" content="Service And Kube-proxy">
<meta property="og:url" content="https://github.com/JianweiWang/JianweiWang.github.io/blob/master/2018/05/27/Service-And-Kube-proxy/index.html">
<meta property="og:site_name" content="Terminus">
<meta property="og:description" content="Introduction本文探究kubernetes架构中，服务发现的具体工作原理，涉及到service定义、服务发现与coredns，kube-proxy工作原理等。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://github.com/JianweiWang/JianweiWang.github.io/blob/master/2018/05/27/Service-And-Kube-proxy/Service-And-Kube-proxy-9a3a490b.png">
<meta property="og:image" content="https://github.com/JianweiWang/JianweiWang.github.io/blob/master/2018/05/27/Service-And-Kube-proxy/Service-And-Kube-proxy-02d62faa.png">
<meta property="og:image" content="https://github.com/JianweiWang/JianweiWang.github.io/blob/master/2018/05/27/Service-And-Kube-proxy/Service-And-Kube-proxy-74a4dc02.png">
<meta property="og:image" content="https://github.com/JianweiWang/JianweiWang.github.io/blob/master/2018/05/27/Service-And-Kube-proxy/Service-And-Kube-proxy-90b65a4a.png">
<meta property="og:image" content="https://github.com/JianweiWang/JianweiWang.github.io/blob/master/2018/05/27/Service-And-Kube-proxy/Service-And-Kube-proxy-9bf039d8.png">
<meta property="og:image" content="https://github.com/JianweiWang/JianweiWang.github.io/blob/master/2018/05/27/Service-And-Kube-proxy/Service-And-Kube-proxy-6cc5b0ce.png">
<meta property="og:image" content="https://github.com/JianweiWang/JianweiWang.github.io/blob/master/2018/05/27/Service-And-Kube-proxy/Service-And-Kube-proxy-d314f07b.png">
<meta property="og:image" content="https://github.com/JianweiWang/JianweiWang.github.io/blob/master/2018/05/27/Service-And-Kube-proxy/Service-And-Kube-proxy-323364fe.png">
<meta property="og:updated_time" content="2021-11-07T07:27:29.660Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Service And Kube-proxy">
<meta name="twitter:description" content="Introduction本文探究kubernetes架构中，服务发现的具体工作原理，涉及到service定义、服务发现与coredns，kube-proxy工作原理等。">
<meta name="twitter:image" content="https://github.com/JianweiWang/JianweiWang.github.io/blob/master/2018/05/27/Service-And-Kube-proxy/Service-And-Kube-proxy-9a3a490b.png">
  
    <link rel="alternate" href="/atom.xml" title="Terminus" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Terminus</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Give time to civilization, not to civilization</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://github.com/JianweiWang/JianweiWang.github.io/blob/master"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Service-And-Kube-proxy" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/27/Service-And-Kube-proxy/" class="article-date">
  <time datetime="2018-05-27T15:07:15.000Z" itemprop="datePublished">2018-05-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Service And Kube-proxy
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>本文探究kubernetes架构中，服务发现的具体工作原理，涉及到service定义、服务发现与coredns，kube-proxy工作原理等。<br><a id="more"></a></p>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>kubernetes架构中，Service是对一组提供相同功能pod的抽象。Service通过标签选取服务后端。Service有四种类型：</p>
<ul>
<li>ClusterIP: 默认类型，为服务自动分配一个虚拟ip，该ip仅集群内部可见</li>
<li>NodePort: 在ClusterIP的基础上，为Service在每台机器上绑定一个端口，外部请求可以通过NodeIP:NodePort访问服务</li>
<li>LoadBalancer: 在NodePort的基础上，通过云服务厂商创建一个外部的负载均衡器</li>
<li>ExternalName: 把服务通过CNAME的方式转发到制定的域名。<br><br></li>
</ul>
<h3 id="创建Service"><a href="#创建Service" class="headerlink" title="创建Service"></a>创建Service</h3><ul>
<li>一般，在创建服务时，需要指定selector，该selector会和特定label关联，通过和pod的label对比，选择相应的pod作为该服务的endpoints；</li>
<li>如果不指定selector，可以自己定义endpoint，需要创建一个和Service同名的Endpoints资源，在endpoint中配置指定的ip和端口；</li>
<li>还有一种情况不需要指定selectors，就是通过DNS CNAME方式把服务转发到指定的域名；<br><br></li>
</ul>
<h3 id="headless-服务"><a href="#headless-服务" class="headerlink" title="headless 服务"></a>headless 服务</h3><p>headless服务是指不需要ClusterIP的服务，在创建服务时指定<code>spec.clusterIP=None</code>, 包括两类：</p>
<ul>
<li>不指定selectors，但设置externalName；</li>
<li>不指定selectors，通过A记录设置后段endpoint列表；</li>
</ul>
<h2 id="Service-Discovery"><a href="#Service-Discovery" class="headerlink" title="Service Discovery"></a>Service Discovery</h2><p>服务发现分两种类型：</p>
<ul>
<li>环境变量<ul>
<li>kubelet 会为每个活跃的 Service 添加一组环境变量，要求 Pod 想要访问的任何 Service 必须在 Pod 自己之前被创建</li>
</ul>
</li>
<li><p>DNS</p>
<ul>
<li>DNS 服务器监视着创建新 Service 的 Kubernetes API，从而为每一个 Service 创建一组 DNS 记录, k8s体系中，DNS服务发现的结构如下图：<br><img src="Service-And-Kube-proxy-9a3a490b.png" alt=""></li>
</ul>
<p>如上图所示，kube-dns 或 coredns会watch api-server上Service的变化，并根据规则自动生成DNS A记录。</p>
</li>
</ul>
<h2 id="Kube-proxy"><a href="#Kube-proxy" class="headerlink" title="Kube-proxy"></a>Kube-proxy</h2><p>用户创建service后，k8s会为这个LB提供一个IP，一般称为cluster IP。 kube-proxy的作用主要是负责service的实现，具体来说，就是实现了内部从pod到service和外部的从node port向service的访问。</p>
<p>kube-proxy内部实现原理主要是使用iptables规则，更改filter和nat表。filter表中增加KUBE-FIREWALL和KUBE-SERVICES两个规则链。所有出的报文都经过KUBE-SERVICES，如果没有找到endpoint，则丢弃报文。nat表则设置的规则比较多，主要是各种跳转，下图1中给出了部分。nat表的处理主要步骤为：</p>
<ul>
<li>inbound：在PREROUTING阶段，将所有报文转发到KUBE-SERVICES</li>
<li>outbound：在OUTPUT阶段，将所有报文转发到KUBE-SERVICES</li>
<li>outbound：在POSTROUTING阶段，将所有报文转发到KUBE-POSTROUTING</li>
</ul>
<p>以my-nginx服务为例，该服务clusterIP为10.254.82.158，有两个pod，ip分贝为172.30.39.3和172.30.23.8，如下图：</p>
<p>  <img src="Service-And-Kube-proxy-02d62faa.png" alt=""></p>
<p>使用sudo iptables -t nat -L命令查看nat转发表，只截出了相关的部分，如下图1。</p>
<ul>
<li>首先pod通过dns查询到clusterIP 10.254.82.158，然后发起调用；</li>
<li>请求进入KUBE-SVC-BEPXDJBUHFCSYIC3</li>
<li>KUBE-SVC-BEPXDJBUHFCSYIC3配置了两个pod的概率，0.5</li>
<li><p>然后请求按照一定概率被转发到另个目的pod，如图2和图3</p>
<p><img src="Service-And-Kube-proxy-74a4dc02.png" alt=""></p>
<center>图1</center>

<p><img src="Service-And-Kube-proxy-90b65a4a.png" alt=""></p>
<center>图2</center>

<p><img src="Service-And-Kube-proxy-9bf039d8.png" alt=""></p>
<center>图3</center>

</li>
</ul>
<p>综上，数据包发到Node的处理过程：</p>
<p><img src="Service-And-Kube-proxy-6cc5b0ce.png" alt=""></p>
<center>图片来自<a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2017/03/27/Kubernetes-kube-proxy.html" target="_blank" rel="noopener">http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2017/03/27/Kubernetes-kube-proxy.html</a></center>


<p>Node发出的包的处理过程：<br><img src="Service-And-Kube-proxy-d314f07b.png" alt=""></p>
<center>图片来自<a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2017/03/27/Kubernetes-kube-proxy.html" target="_blank" rel="noopener">http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2017/03/27/Kubernetes-kube-proxy.html</a></center>

<h2 id="CoreDNS"><a href="#CoreDNS" class="headerlink" title="CoreDNS"></a>CoreDNS</h2><p>CoreDNS在k8s中主要负责把Service转换成DNS域名并添加相应的A记录。CoreDNS支持标准的dns协议，插件化，支持多种数据源。</p>
<p><img src="Service-And-Kube-proxy-323364fe.png" alt=""></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>综上，本文简单介绍了kubernetes体系中，服务发现相关的概念及原理，包括服务类型、服务定义、服务发现方式及kube-proxy的工作原理。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/JianweiWang/JianweiWang.github.io/blob/master/2018/05/27/Service-And-Kube-proxy/" data-id="ckvp3lv1u0005sjsg2v637jc4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/service/">service</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/05/28/DNS-Cache-In-Linux/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          DNS Cache In Linux
        
      </div>
    </a>
  
  
    <a href="/2018/05/27/Network-Model-in-Kubernetes/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Network Model in Kubernetes</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/reading/">reading</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/LeetCode/">LeetCode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/alogrithm/">alogrithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes-Network/">kubernetes Network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux-perf-tools/">linux perf tools</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/service/">service</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/something-of-everyday/">something of everyday</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/读书/">读书</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/LeetCode/" style="font-size: 10px;">LeetCode</a> <a href="/tags/alogrithm/" style="font-size: 20px;">alogrithm</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/kubernetes-Network/" style="font-size: 10px;">kubernetes Network</a> <a href="/tags/linux-perf-tools/" style="font-size: 10px;">linux perf tools</a> <a href="/tags/service/" style="font-size: 10px;">service</a> <a href="/tags/something-of-everyday/" style="font-size: 20px;">something of everyday</a> <a href="/tags/读书/" style="font-size: 10px;">读书</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/11/14/leetcode04/">leetcode04</a>
          </li>
        
          <li>
            <a href="/2020/11/08/20201108/">20201108</a>
          </li>
        
          <li>
            <a href="/2020/11/05/20201104/">20201104</a>
          </li>
        
          <li>
            <a href="/2019/05/27/linux-strace-command-introduction/">linux strace command introduction</a>
          </li>
        
          <li>
            <a href="/2019/05/26/golang-learning-01/">golang learning 01</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 正己<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>