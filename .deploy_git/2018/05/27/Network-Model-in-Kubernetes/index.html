<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Network Model in Kubernetes | Terminus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本文主要剖析kubernetes中网络模型，详细介绍pod之间的通信流程。 网络模型概况kubernetes对网络的要求 所有的容器都可以在不用NAT的方式下同别的容器通信 所有容器节点都可以在不用NAT的方式下同所有容器通信 容器的地址和别人看到的地址是同一个地址">
<meta name="keywords" content="kubernetes Network">
<meta property="og:type" content="article">
<meta property="og:title" content="Network Model in Kubernetes">
<meta property="og:url" content="https://github.com/JianweiWang/JianweiWang.github.io/blob/master/2018/05/27/Network-Model-in-Kubernetes/index.html">
<meta property="og:site_name" content="Terminus">
<meta property="og:description" content="本文主要剖析kubernetes中网络模型，详细介绍pod之间的通信流程。 网络模型概况kubernetes对网络的要求 所有的容器都可以在不用NAT的方式下同别的容器通信 所有容器节点都可以在不用NAT的方式下同所有容器通信 容器的地址和别人看到的地址是同一个地址">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://github.com/JianweiWang/JianweiWang.github.io/blob/master/2018/05/27/Network-Model-in-Kubernetes/Network-Model-in-Kubernetes-6c165903.png">
<meta property="og:updated_time" content="2021-11-07T07:27:29.659Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Network Model in Kubernetes">
<meta name="twitter:description" content="本文主要剖析kubernetes中网络模型，详细介绍pod之间的通信流程。 网络模型概况kubernetes对网络的要求 所有的容器都可以在不用NAT的方式下同别的容器通信 所有容器节点都可以在不用NAT的方式下同所有容器通信 容器的地址和别人看到的地址是同一个地址">
<meta name="twitter:image" content="https://github.com/JianweiWang/JianweiWang.github.io/blob/master/2018/05/27/Network-Model-in-Kubernetes/Network-Model-in-Kubernetes-6c165903.png">
  
    <link rel="alternate" href="/atom.xml" title="Terminus" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Terminus</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Give time to civilization, not to civilization</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://github.com/JianweiWang/JianweiWang.github.io/blob/master"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Network-Model-in-Kubernetes" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/27/Network-Model-in-Kubernetes/" class="article-date">
  <time datetime="2018-05-27T11:00:45.000Z" itemprop="datePublished">2018-05-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Network Model in Kubernetes
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文主要剖析kubernetes中网络模型，详细介绍pod之间的通信流程。</p>
<h2 id="网络模型概况"><a href="#网络模型概况" class="headerlink" title="网络模型概况"></a>网络模型概况</h2><h3 id="kubernetes对网络的要求"><a href="#kubernetes对网络的要求" class="headerlink" title="kubernetes对网络的要求"></a>kubernetes对网络的要求</h3><ul>
<li>所有的容器都可以在不用NAT的方式下同别的容器通信</li>
<li>所有容器节点都可以在不用NAT的方式下同所有容器通信</li>
<li>容器的地址和别人看到的地址是同一个地址<a id="more"></a>
<h3 id="kubernetes的网络场景"><a href="#kubernetes的网络场景" class="headerlink" title="kubernetes的网络场景"></a>kubernetes的网络场景</h3></li>
<li><p>容器间直接通信</p>
<p>同一个pod中，不通容器共享一个网络命名空间，共享同一个Linux协议栈，可以直接通过localhost通信。</p>
</li>
<li><p>同一个Node上pod间的通信</p>
<p>同一个Node内，不同的Pod都有一个全局IP，可以直接通过Pod的IP进行通信。Pod地址和docker0在同一个网段</p>
</li>
<li><p>不同Node上的pod间通信</p>
<p>docker0网桥与宿主机网卡是两个完全不同的IP网段，并且Node之间的通信只能通过宿主机的物理网卡进行，因此要想实现位于不同Node上的Pod容器之间的通信，就必须想办法通过主机的IP地址进行寻址和通信。Kubernetes会记录所有正在运行的Pod的IP分配信息，并且将这些信息保存在etcd中（作为service的Endpoint）。</p>
<p>因此，实现不同Node上pod之间的通信，需要两个条件</p>
<ul>
<li>pod IP做整体规划，整个kubernetes集群内的pod IP不能有冲突，一般通过第三方开源工具管理，如flannel</li>
<li>将Node IP与该Node内的pod IP关联起来，通过Node IP转发到pod IP</li>
</ul>
</li>
<li><p>pod到service的通信</p>
<p>pod到service的通信通过kube-proxy实现，底层通过修改iptables规则实现，后文具体介绍。</p>
</li>
<li><p>集群外部与内部组件的通信</p>
<p>通过NodePort或者Ingress实现；</p>
</li>
</ul>
<h3 id="kubernetes网络结构"><a href="#kubernetes网络结构" class="headerlink" title="kubernetes网络结构"></a>kubernetes网络结构</h3><p>为了满足上述要求和场景，kubernetes集群的网络分为三层：</p>
<ul>
<li>集群物理网络，即Node节点所属网络；</li>
<li>Node内部的容器网络，一般是docker0网卡负责管理；</li>
<li>Node网络和容器网络的连接器，overlay网络，一般flannel负责管理；</li>
</ul>
<p>三层网络的结构下图：</p>
<p><img src="Network-Model-in-Kubernetes-6c165903.png" alt=""></p>
<p><center>kubernetes网络结构</center><br><br><br><br></p>
<p>其中，docker0是Node内部不通pod间的默认路由，pod的IP地址从docker0动态分配；flannel负责overylay网络维护，把docker0内的私网和Node节点的网络打通；GateWay则是Node网络中的默认路由，负责物理网络数据包转发。</p>
<h3 id="开源网络组件Flannel"><a href="#开源网络组件Flannel" class="headerlink" title="开源网络组件Flannel"></a>开源网络组件Flannel</h3><p>在kubernetes中，flannel的左右有以下两点：</p>
<ul>
<li>给每个Node上的Docker容器分配不冲突的IP地址</li>
<li>在这些IP之间建立一个覆盖网络(Overlay Network),通过这个覆盖网络，将数据包原封不动的传递到目标容器内</li>
</ul>
<p>首先，flannel创建一个flannel0网桥，一端连接docker0网桥，另一端连接flanneld的服务进程。flanneld进程跟kubernetes集群中的etcd通信，管理网段资源，同时监控每个pod的实际地址，并在内存中建立一个pod节点的路由表。flanneld进程一端连接flannel0网桥，另一端连接物理网络。</p>
<p><br></p>
<p>综上，以pod0和pod2的通信为例，数据的流转是这样的：</p>
<p>pod0 –&gt; docker0 –&gt; flannel0 –&gt; flanneld –&gt; Node0物理网卡 –&gt; Node1物理网卡 –&gt; flanneld –&gt; flannel0 –&gt; docker0 –&gt; pod2</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/JianweiWang/JianweiWang.github.io/blob/master/2018/05/27/Network-Model-in-Kubernetes/" data-id="ckvp2t8ue0006hasgb63czmkr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes-Network/">kubernetes Network</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/05/27/Service-And-Kube-proxy/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Service And Kube-proxy
        
      </div>
    </a>
  
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/reading/">reading</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/LeetCode/">LeetCode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/alogrithm/">alogrithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes-Network/">kubernetes Network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux-perf-tools/">linux perf tools</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/service/">service</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/something-of-everyday/">something of everyday</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/读书/">读书</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/LeetCode/" style="font-size: 10px;">LeetCode</a> <a href="/tags/alogrithm/" style="font-size: 20px;">alogrithm</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/kubernetes-Network/" style="font-size: 10px;">kubernetes Network</a> <a href="/tags/linux-perf-tools/" style="font-size: 10px;">linux perf tools</a> <a href="/tags/service/" style="font-size: 10px;">service</a> <a href="/tags/something-of-everyday/" style="font-size: 20px;">something of everyday</a> <a href="/tags/读书/" style="font-size: 10px;">读书</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/11/14/leetcode04/">leetcode04</a>
          </li>
        
          <li>
            <a href="/2020/11/08/20201108/">20201108</a>
          </li>
        
          <li>
            <a href="/2020/11/05/20201104/">20201104</a>
          </li>
        
          <li>
            <a href="/2019/05/27/linux-strace-command-introduction/">linux strace command introduction</a>
          </li>
        
          <li>
            <a href="/2019/05/26/golang-learning-01/">golang learning 01</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 正己<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>